<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <title>Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="https://heaciy.com/favicon.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
        integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand " href="#">Crontab</a>
            <button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                data-target="#navbarsExample07" aria-controls="navbarsExample07" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="navbar-collapse collapse" id="navbarsExample07">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Info</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#">Disabled</a>
                    </li>
                    {% if request.user.is_superuser %}
                    <li class="nav-item">
                        <a class="nav-link" href="/admin" target="_blank">Admin</a>
                    </li>
                    {% endif %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown07"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            {% if request.user.is_authenticated %}{{user.username}}{% endif %}</a>
                        <div class="dropdown-menu" aria-labelledby="dropdown07">
                            <a class="dropdown-item" href="#">Profile</a>
                            <a class="dropdown-item" href="#">Settings</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="{% url 'logout' %}">Sign out</a>
                        </div>
                    </li>
                </ul>
                <form class="form-inline my-2 my-md-0">
                    <input class="form-control" type="text" placeholder="Search" aria-label="Search">
                </form>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="rounded-lg my-4 px-5 py-4" style="background-color: aliceblue;">
            <h3><button type="button" class="badge badge-success btn" id="addBtn">New</button></h3>
            <form id='taskForm'>
                <div class="form-row">
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Name" id="fname" required>
                    </div>
                    <div class="col">
                        <select class="form-control" id="ftask" disabled>
                            <option selected value="task.tasks.add" selected>DailyCP</option>
                        </select>
                    </div>
                    <div class="col">
                        <select class="form-control" id="foption">
                            <option selected value="1">签到</option>
                            <option value="2">填表</option>
                            <option value="4">查寝</option>
                            <!-- <option value="4">通知</option> -->
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Number of Periods" id="fevery" value="1"
                            required>
                    </div>
                    <div class="col">
                        <select class="form-control" id="fperiod" placeholder="Interval Period">
                            <option value="1">Days</option>
                            <option value="2">Hours</option>
                            <option value="4">Minutes</option>
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Args" id="fargs" value="[]">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Kwargs" id="fkwargs" value="{}">
                    </div>
                </div>
            </form>
        </div>
        <div class="rounded-lg my-4 px-5 py-4" style="background-color: aliceblue;">
            <h3><button type="button" class="badge badge-info btn" id="tasksBtn">Tasks</span></h3>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Task</th>
                        <th scope="col">Args</th>
                        <th scope="col">Kwargs</th>
                        <th scope="col">Count</th>
                        <th scope="col">Update</th>
                        <th scope="col">description</th>
                        <th scope="col">Enabled</th>
                        <th scope="col">Test</th>
                        <th scope="col">Delete</th>
                    </tr>
                </thead>
                <tbody id="tasksTab">
                    <tr>
                        <th scope="row">1</th>
                        <td>task.name</td>
                        <td>task.task.generic</td>
                        <td>[]</td>
                        <td>{}</td>
                        <td>32</td>
                        <td>2021-09-01 12:46:31</td>
                        <td>generic task</td>
                        <td>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="cb1">
                                <label class="custom-control-label" for="cb1"></label>
                            </div>
                        </td>
                        <td><a class="btn btn-sm btn-outline-success btn-test py-0" tid=1 href="#">test</a></td>
                        <td><a class="btn btn-sm btn-outline-danger btn-del py-0" tid=1 href="#">del</a></td>
                    </tr>
                    <tr>
                        <th scope="row">
                            </script>2</th>
                        <td>task.name</td>
                        <td>task.task.generic</td>
                        <td>[]</td>
                        <td>{}</td>
                        <td>32</td>
                        <td>2021-09-01 12:46:31</td>
                        <td>generic task</td>
                        <td>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="cb2">
                                <label class="custom-control-label" for="cb2"></label>
                            </div>
                        </td>
                        <td><a class="btn btn-sm btn-outline-success py-0" href="#">test</a></td>
                        <td><a class="btn btn-sm btn-outline-danger btn-del py-0" tid=1 href="#">del</a></td>
                    </tr>
                    <tr>
                        <th scope="row">3</th>
                        <td>task.name</td>
                        <td>task.task.generic</td>
                        <td>[]</td>
                        <td>{}</td>
                        <td>32</td>
                        <td>2021-09-01 12:46:31</td>
                        <td>generic task</td>
                        <td>
                            <div class="custom-control custom-switch">
                                <input type="checkbox" class="custom-control-input" id="cb3">
                                <label class="custom-control-label" for="cb3"></label>
                            </div>
                        </td>
                        <td><a class="btn btn-sm btn-outline-success py-0" href="#">test</a></td>
                        <td><a class="btn btn-sm btn-outline-danger btn-del py-0" tid=1 href="#">del</a></td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="rounded-lg my-4 px-5 py-4" style="background-color: aliceblue;">
            <h3><button type="button" class="badge badge-warning btn" id="resultsBtn">Results</span></h3>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Task</th>
                        <th scope="col">Args</th>
                        <th scope="col">Kwargs</th>
                        <th scope="col">Status</th>
                        <th scope="col">Result</th>
                        <th scope="col">Date</th>

                    </tr>
                </thead>
                <tbody id="resultsTab">
                    <tr>
                        <th scope="row">1</th>
                        <td>task.name</td>
                        <td>task.task.generic</td>
                        <td>[]</td>
                        <td>{}</td>
                        <td>SUCCESS</td>
                        <td>None</td>
                        <td>2021-08-31 15:36:44</td>
                    </tr>
                    <tr>
                        <th scope="row">2</th>
                        <td>task.name</td>
                        <td>task.task.generic</td>
                        <td>[]</td>
                        <td>{}</td>
                        <td>SUCCESS</td>
                        <td>None</td>
                        <td>2021-08-31 15:36:44</td>
                    </tr>
                    <tr>
                        <th scope="row">3</th>
                        <td>task.name</td>
                        <td>task.task.generic</td>
                        <td>[]</td>
                        <td>{}</td>
                        <td>SUCCESS</td>
                        <td>None</td>
                        <td>2021-08-31 15:36:44</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <!-- modal提示框 -->
    <div class="modal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p>Modal body text goes here.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
<script type="text/javascript">
    let urls = {
        add: '{% url "add_task" %}',
        tasks: '{% url "get_tasks" %}',
        results: '{% url "get_results" %}',
        runTask: '{% url "run_task" %}',
        enableTask: '{% url "enable_task" %}',
        delTask: '{% url "delete_task" %}',
    }
    var data
    function load_data(apiStr) {
        var defer = $.Deferred()
        $.ajax({
            url: apiStr,
            type: 'GET',
            cacahe: false,
            dataType: "json",
            success: function (result) {
                if (result.state.toLowerCase() === "success") {
                    defer.resolve(result.data)
                }
            },
            error: function (err) {
                alert("请求发生错误！")
            }
        })
        return defer.promise()
    }
    $("#tasksBtn").click(() => load_task_table())
    $("#resultsBtn").click(() => load_result_table())

    function load_task_table() {
        let taskBtn = $('#tasks')
        taskBtn.attr("disabled", true)  // 关闭taskBtn按钮
        let tab = $('#tasksTab')
        let tbody = ""
        $.when(load_data(urls.tasks)).done(function (result) {
            data = result
            taskBtn.attr("disabled", false)  // 恢复taskBtn按钮
            for (var index in data) {
                var task = data[index]
                let cb = `cb-${task.tid}`
                var enable = `<td><div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" tid=${task.tid} id=${cb}><label class="custom-control-label" for=${cb}></label></div></td>`
                if (JSON.parse(task.enabled.toLowerCase())) {
                    enable = `<td><div class="custom-control custom-switch"><input type="checkbox" class="custom-control-input" tid=${task.tid} id=${cb} checked><label class="custom-control-label" for=${cb}></label></div></td>`
                }
                // let rowEle = `<tr><th scope="row">${parseInt(index) + 1}</th><td>${task.name}</td><td>${task.task}</td><td>${JSON.stringify(task.args)}</td><td>${JSON.stringify(task.kwargs)}</td><td>${task.total_run_count}</td><td>${task.date_changed}</td><td>${task.description}</td><td>${task.enabled}</td><td><a class="btn btn-sm btn-outline-success py-0 btn-test" tid=${task.tid} href="#">test</a></td></tr>`
                let rowEle = `<tr><th scope="row">${parseInt(index) + 1}</th><td>${task.name}</td><td>${task.task}</td><td>${JSON.stringify(task.args)}</td><td>${JSON.stringify(task.kwargs)}</td><td>${task.total_run_count}</td><td>${task.date_changed}</td><td>${task.description}</td>${enable}<td><a class="btn btn-sm btn-outline-success py-0 btn-test" tid=${task.tid} href="#">test</a></td><td><a class="btn btn-sm btn-outline-danger py-0 btn-del" tid=${task.tid} href="#">test</a></td></tr>`
                tbody += rowEle
            }
            tab.html(tbody)
            $("a.btn-test").click(function () {
                $(this).addClass('disabled')  // 关闭test按钮
                run_task($(this).attr('tid'))
                $(this).removeClass('disabled')  // 开启test按钮
            });
            $("a.btn-del").click(function () {
                $(this).addClass('disabled')  // 关闭del按钮
                del_task($(this).attr('tid'))
                $(this).removeClass('disabled')  // 开启del按钮
            });
            $("input:checkbox").change(function () {
                if (this.checked) {
                    console.log(`${$(this).attr('tid')} checked`)
                    enable_task($(this).attr('tid'))
                } else {
                    console.log(`${$(this).attr('tid')} uncheck`)
                    enable_task($(this).attr('tid'))
                }
            });
        })
    }
    function load_result_table() {
        let resultBtn = $('#results')
        resultBtn.attr("disabled", true)  // 关闭resultBtn按钮
        let tab = $('#resultsTab')
        let tbody = ""
        $.when(load_data(urls.results)).done(function (result) {
            data = result
            resultBtn.attr("disabled", false)  // 恢复resultBtn按钮
            for (var index in data) {
                var result = data[index]
                let rowEle = `<tr><th scope="row">${parseInt(index) + 1}</th><td>${result.task_obj}</td><td>${result.task_name}</td><td>${JSON.stringify(result.task_args)}</td><td>${JSON.stringify(result.task_kwargs)}</td><td>${result.status}</td><td>${result.result}</td><td>${result.date_done}</td></tr>`
                tbody += rowEle
            }
            tab.html(tbody)
        })
    }
    window.onload = () => { load_task_table(); load_result_table(); }
</script>
<script>
    function enable_task(tid_) {
        $.get(urls.enableTask, { tid: tid_ },
            function (result) {
                console.log(result)
                if (result.state.toLowerCase() == "success") {
                    alert(result.state)
                } else {
                    alert(result.state)
                }
            });
    }
    function run_task(tid_) {
        $.get(urls.runTask, { tid: tid_ },
            function (result) {
                console.log(result)
                if (result.state.toLowerCase() == "success") {
                    alert(result.state)
                } else {
                    alert(result.state)
                }
            });
    }
    function del_task(tid_) {
        if(confirm("确认要删除？")){
            $.get(urls.delTask, { tid: tid_ },
            function (result) {
                if (result.state.toLowerCase() == "success") {
                    alert(result.state)
                    load_task_table() // 重新加载task table
                } else {
                    alert(result.state)
                }
            })
        }
    }
</script>
<script>
    $("#addBtn").click(() => add_interval_task())
    function parse_data_form() {
        period = { 1: "DAYS", 2: "HOURS", 4: "MINUTES" }
        err = []
        data = {}
        formData = {
            name: $('#fname').val(),
            task: $('#ftask').val(),
            every: parseInt($('#fevery').val()),
            period: period[parseInt($('#fperiod').val())],
        }
        if (formData["name"].replace(/(^s*)|(s*$)/g, "").length == 0) {
            err.push("Task name cannot be null!")
        }
        if (formData["task"].replace(/(^s*)|(s*$)/g, "").length == 0) {
            err.push("Task cannot be null!")
        }
        if (Number.isNaN(formData["every"])) {
            err.push("Every cannot be null!")
        }
        if (formData["period"].replace(/(^s*)|(s*$)/g, "").length == 0) {
            err.push("Period cannot be null!")
        }
        try {
            formData.args = [JSON.parse($('#foption').val())].concat(Array.from(JSON.parse($('#fargs').val())))
        } catch (e) {
            err.push("Args must be a list!")
        }
        try {
            formData.kwargs = JSON.parse($('#fkwargs').val().replace(/'/g, '"'))
        } catch (e) {
            err.push("Kwargs must be a dict!")
        }
        data.data = formData
        data.err = err
        if (err.length != 0) {
            data.valid = false
        } else {
            data.valid = true
        }
        return data
    }
    function clean_form() {
        $('#fname').val('')
        $('#fevery').val('')
        $('#foption').val('[]')
        $('#fkwargs').val('{}')
    }
    function add_interval_task() {
        let addBtn = $('#add')
        addBtn.attr("disabled", true)  // 关闭add按钮
        valied_data = parse_data_form()
        if (valied_data.valid) {
            $.post(urls.add, { data: JSON.stringify(valied_data.data) }, function (result) {
                if (result.state.toLowerCase() == "success") {
                    console.log("success")
                    alert(JSON.stringify("success"))
                    clean_form()
                } else {
                    console.log("failed")
                    alert(JSON.stringify(result.err))
                }
                addBtn.attr("disabled", false)  // 恢复add按钮
                load_task_table()  // 更新任务
            })
        } else {
            alert(JSON.stringify(valied_data.err))
            addBtn.attr("disabled", false)  // 恢复add按钮
        }
    }
</script>
<script>
    setInterval(load_result_table, 1000 * 30)
</script>

</html>