<!DOCTYPE html>
<!-- {% load static %} -->
<html lang="en">

<head>
    <title>Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" type="image/png" href="https://heaciy.com/favicon.ico" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <!-- <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
        crossorigin="anonymous"></script> -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"
        integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF"
        crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-success">
        <div class="container">
            <a class="navbar-brand " href="#">Crontab</a>
            <button class="navbar-toggler collapsed" type="button" data-toggle="collapse"
                data-target="#navbarsExample07" aria-controls="navbarsExample07" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="navbar-collapse collapse" id="navbarsExample07">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Link</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Info</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link disabled" href="#">Disabled</a>
                    </li>
                    {% if request.user.is_superuser %}
                    <li class="nav-item">
                        <a class="nav-link" href="/admin" target="_blank">Admin</a>
                    </li>
                    {% endif %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="http://example.com" id="dropdown07"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            {% if request.user.is_authenticated %}{{user.username}}{% endif %}</a>
                        <div class="dropdown-menu" aria-labelledby="dropdown07">
                            <a class="dropdown-item" href="#">Profile</a>
                            <a class="dropdown-item" href="#">Settings</a>
                            <div class="dropdown-divider"></div>
                            <a class="dropdown-item" href="#">Sign out</a>
                        </div>
                    </li>
                </ul>
                <form class="form-inline my-2 my-md-0">
                    <input class="form-control" type="text" placeholder="Search" aria-label="Search">
                </form>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="rounded-lg my-4 px-5 py-4" style="background-color: aliceblue;">
            <h3><span class="badge badge-success">New</span></h3>
            <form>
                <div class="form-row">
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Name">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Task">
                    </div>
                    <div class="col">
                        <select class="form-control">
                            <option selected>签到</option>
                            <option>填表</option>
                            <option>查寝</option>
                            <option>通知</option>
                        </select>
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Crontab">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Args">
                    </div>
                    <div class="col">
                        <input type="text" class="form-control" placeholder="Kwargs">
                    </div>
                </div>
            </form>
        </div>
        <div class="rounded-lg my-4 px-5 py-4" style="background-color: aliceblue;">
            <h3><span class="badge badge-info btn" id="tasks">Tasks</span></h3>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Task</th>
                        <th scope="col">Args</th>
                        <th scope="col">Kwargs</th>
                        <th scope="col">Enabled</th>
                        <th scope="col">Count</th>
                        <th scope="col">Update</th>
                        <th scope="col">description</th>
                    </tr>
                </thead>
                <tbody id="tasksTab">
                    <tr>
                        <th scope="row">1</th>
                        <td>Mark</td>
                        <td>Otto</td>
                        <td>@mdo</td>
                        <td>@mdo</td>
                        <td>Mark</td>
                        <td>Otto</td>
                        <td>@mdo</td>
                        <td>@mdo</td>
                    </tr>
                    <tr>
                        <th scope="row">2</th>
                        <td>Jacob</td>
                        <td>Thornton</td>
                        <td>@fat</td>
                        <td>@fat</td>
                        <td>Jacob</td>
                        <td>Thornton</td>
                        <td>@fat</td>
                        <td>@fat</td>
                    </tr>
                    <tr>
                        <th scope="row">3</th>
                        <td>Larry</td>
                        <td>the Bird</td>
                        <td>@twitter</td>
                        <td>@twitter</td>
                        <td>Larry</td>
                        <td>the Bird</td>
                        <td>@twitter</td>
                        <td>@twitter</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="rounded-lg my-4 px-5 py-4" style="background-color: aliceblue;">
            <h3><span class="badge badge-warning btn" id="results">Results</span></h3>
            <table class="table">
                <thead class="thead-dark">
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Name</th>
                        <th scope="col">Task</th>
                        <th scope="col">Args</th>
                        <th scope="col">Kwargs</th>
                        <th scope="col">Status</th>
                        <th scope="col">Result</th>
                        <th scope="col">Date</th>

                    </tr>
                </thead>
                <tbody id="resultsTab">
                    <tr>
                        <th scope="row">1</th>
                        <td>Mark</td>
                        <td>Otto</td>
                        <td>@mdo</td>
                        <td>@mdo</td>
                        <td>@mdo</td>
                        <td>Mark</td>
                        <td>Otto</td>
                    </tr>
                    <tr>
                        <th scope="row">2</th>
                        <td>Jacob</td>
                        <td>Thornton</td>
                        <td>@fat</td>
                        <td>@mdo</td>
                        <td>@mdo</td>
                        <td>Mark</td>
                        <td>Otto</td>
                    </tr>
                    <tr>
                        <th scope="row">3</th>
                        <td>Larry</td>
                        <td>the Bird</td>
                        <td>@twitter</td>
                        <td>@mdo</td>
                        <td>@mdo</td>
                        <td>Mark</td>
                        <td>Otto</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</body>
<script type="text/javascript">
    let urls = {
        tasks: '{% url "get_task" %}',
        results: '{% url "get_results" %}'
    }
    var data
    function load_data(apiStr) {
        var defer = $.Deferred()
        $.ajax({
            url: apiStr,
            type: 'GET',
            cacahe: false,
            dataType: "json",
            success: function (result) {
                if (result.state.toLowerCase() === "success") {
                    defer.resolve(result.data)
                }
            },
            error: function (err) {
                alert("请求发生错误！")
            }
        })
        return defer.promise()
    }
    $("#tasks").click(() => load_task_table())
    $("#results").click(() => load_result_table())

    function load_task_table() {
        let tab = $('#tasksTab')
        let tbody = ""
        $.when(load_data(urls.tasks)).done(function (result) {
            data = result
            for (var index in data) {
                var task = data[index]
                let rowEle = `<tr><th scope="row">${parseInt(index)+1}</th><td>${task.name}</td><td>${task.task}</td><td>${JSON.stringify(task.args)}</td><td>${JSON.stringify(task.kwargs)}</td><td>${task.enabled}</td><td>${task.total_run_count}</td><td>${task.date_changed}</td><td>${task.description}</td></tr>`
                tbody += rowEle
            }
            tab.html(tbody)
        })
    }
    function load_result_table() {
            let tab = $('#resultsTab')
            let tbody = ""
            $.when(load_data(urls.results)).done(function (result) {
                data = result
                console.log(data)
                for (var index in data) {
                    var result = data[index]
                    let rowEle = `<tr><th scope="row">${parseInt(index) + 1}</th><td>${result.task_obj}</td><td>${result.task_name}</td><td>${JSON.stringify(result.task_args)}</td><td>${JSON.stringify(result.task_kwargs)}</td><td>${result.status}</td><td>${result.result}</td><td>${result.date_done}</td></tr>`
                    tbody += rowEle
                }
                tab.html(tbody)
            })
        }
    window.onload = () => { load_task_table(); load_result_table(); }
</script>

</html>